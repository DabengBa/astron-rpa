---

# 离线绿色便携运行（Stand-alone Portable Offline）PRD

260115

## 1. 真实目标与核心痛点（Why）

用户希望获得一个“解压即用”的 RPA 桌面工作站，在 Windows 强管控环境中也能稳定运行：
- 完全本地运行、完全离线（不需要也不应依赖互联网）
- 无需管理员权限（用户态即可运行）
- 无需防火墙权限（允许本机 loopback 通信）
- 尽量保留现有产品功能；若某功能离线确实不可达，则在 UI 置灰并明确标注不可用原因
- 不需要任何授权/许可能力
- 移除登录流程（包含在线登录与离线登录/授权入口）

核心痛点：
- 企业/政企环境网络隔离、终端权限受限，传统“安装器 + 在线依赖/更新 + 登录授权”模式无法落地。
- 产品一旦存在默认出网（更新检查、市场资源、云 API、遥测上报等），会被安全审计阻断，甚至导致启动卡顿/失败。
- 用户需要的是“可复制部署”的交付形态：同一 zip 包拷贝到任意机器/任意目录都能运行，且数据完全留在本地。

## 2. 范围与交付（What）

本迭代交付一份可直接指导实现与验收的 MVP 规格：定义离线绿色便携版的默认行为、能力边界、降级策略与验收口径。

### 2.1 本次迭代必须交付（MVP）

- 绿色便携（Portable）
  - 用户从离线介质获取一个 zip 包。
  - 解压到任意用户可写目录即可运行（不需要安装）。
  - 允许首次启动在解压目录内自初始化（创建目录、解压内置 runtime/资源、生成默认配置）。

- 完全离线（Offline-First）
  - 首次启动/日常使用不需要互联网。
  - 默认行为不得主动访问互联网；若机器有网也不应因默认流程产生出网请求。

- 无管理员权限（User-Mode）
  - 不写入系统目录（Program Files/Windows/System32 等）。
  - 不写入系统级注册表（HKLM）。
  - 不注册系统服务、不要求驱动安装。

- 无需防火墙权限（Loopback Only）
  - 允许本机回环（127.0.0.1）通信。
  - 全部本地服务（引擎与配套服务）默认只监听 127.0.0.1，不监听 0.0.0.0/外网卡。
  - 不要求用户新增任何防火墙入站规则。

- 无登录、无授权
  - 移除登录流程（在线/离线登录入口均不出现）。
  - 不需要 license 文件、激活、账号体系。

- 核心功能闭环
  - 桌面端可启动并拉起本地引擎/必要服务。
  - 可运行一个本地示例流程，并在 UI 中查看运行日志与输出。

### 2.2 明确不做（边界）

- 不承诺必须依赖互联网的能力在离线可用（MVP 阶段统一置灰标注“离线不可用”）：
  - 在线更新/检查更新
  - 在线市场/资源商店
  - 云端 OCR/LLM/AI 推理（若当前实现依赖云端）
  - 云端同步、云端日志

- 不提供“对外网络可访问”的远程控制/远程调试默认开启方案。

- 本 PRD 只定义需求与验收口径，不在此阶段要求具体代码改动清单。

## 3. 使用场景（When）

- 政企/生产网隔离：无外网、DNS/代理不可用。
- 终端无管理员权限：只能运行用户态应用。
- 终端安全策略严格：不能新增防火墙规则、不能对外开放端口。
- 需要 U 盘/内网共享分发：多机复制部署、目录可随意变更。

## 4. 端到端工作流（Happy Path）

1. 用户获取离线 zip 包（U 盘/内网共享）。
2. 将 zip 解压到任意目录（例如 `D:\Tools\AstronRPA` 或 U 盘目录）。
3. 双击启动桌面端应用。
4. 桌面端在本机用户态启动引擎与必要本地服务（全部 loopback-only）。
5. 用户打开本地示例项目/流程，点击运行。
6. 引擎执行流程，输出本地日志、截图、结果文件到解压目录下的 data 目录。
7. 用户在 UI 查看运行记录，必要时导出诊断包，关闭应用。

## 5. 功能需求（Functional Requirements）

### 5.1 打包与启动

- FR-1：交付物为 zip 免安装包。
- FR-2：首次启动允许在解压目录生成以下内容：
  - `data/`（用户数据与运行输出）
  - `runtime/`（内置运行时解压目录，例如 Python runtime；具体内容以实现为准）
  - `config/`（默认配置）
- FR-3：启动速度要求：在“断网”环境下启动不应因网络超时而显著卡顿（网络请求必须默认关闭或快速失败）。

### 5.2 本地服务编排与通信

- FR-4：桌面端负责本地进程编排：启动/停止/重启引擎与必要服务。
- FR-5：全部本地服务只允许监听 127.0.0.1（全局非功能性需求）。
- FR-6：固定入口端口：`route_port=13159` 作为唯一固定入口端口（第一个固定接口）。
  - 说明：该端口用于健康检查/就绪探测/能力发现等入口级能力；避免引入第二个“ENTRY_PORT”。
  - 端口冲突必须有明确处理策略（见异常场景）。

### 5.3 数据与便携性

- FR-7：所有可变数据默认写入解压目录（便携优先），不得默认写入 `%APPDATA%/%LOCALAPPDATA%`。
- FR-8：卸载即删除：删除解压目录即可清除全部数据（除非用户主动导出/另存）。
- FR-9：提供“导出诊断包”功能，输出到解压目录下 `exports/diagnostics/`（或实现定义的导出目录）。

### 5.4 离线模式与功能可用性

- FR-10：默认处于离线模式；任何“在线能力”入口在离线模式下统一置灰并标注“离线不可用”。
- FR-11：尽量保留现有功能：只要能在用户态 + loopback + 无网条件下实现，则应保持可用。
- FR-12：若某功能离线实现存在重大困难，必须在实现前单独向产品确认是否：
  - 做离线替代方案（例如本地模型/本地服务）
  - 或先置灰后续迭代实现

## 6. 交互与体验要求（UX Requirements）

- UX-1：启动后不出现任何登录/授权页面与入口。
- UX-2：离线不可用的功能入口置灰，并提供一致的说明文案（例如：“当前为离线便携模式，该功能需要联网，暂不可用”）。
- UX-3：关键运行状态可视化：引擎是否启动、`route_port=13159` 状态、最近一次运行是否成功、错误摘要。
- UX-4：错误提示必须可操作：目录无写权限、端口冲突、依赖缺失、被安全软件拦截等应给出明确解决建议。

## 7. 输出与数据（Deliverables）

### 7.1 交付物

- `AstronRPA-standalone-portable-offline.zip`（示例命名，仅用于表达交付形态）

### 7.2 目录结构（建议约定）

- `./app/`：桌面端应用文件
- `./runtime/`：内置运行时（如 Python runtime、必要的依赖资源）
- `./data/`：用户数据
  - `./data/config/`：配置
  - `./data/logs/`：日志
  - `./data/runs/`：运行输出
  - `./data/cache/`：缓存
- `./exports/`：用户导出
  - `./exports/diagnostics/`：诊断包

## 8. 异常与极端场景（明确处理）

- EX-1：机器完全无网络
  - 期望：正常启动与运行，不因网络超时卡住。

- EX-2：机器有网络但被代理/证书拦截
  - 期望：不影响核心功能；在线能力保持置灰或提示不可用。

- EX-3：解压目录不可写（只读介质/权限不足）
  - 期望：启动时检测并提示用户更换到可写目录；不得静默失败。

- EX-4：固定入口端口 `route_port=13159` 被占用
  - 期望：给出明确提示与解决建议；MVP 可以直接终止启动以避免不确定状态。

- EX-5：安全软件拦截子进程启动
  - 期望：UI 给出错误摘要与诊断包导出入口，包含被拦截进程、路径、错误码。

- EX-6：系统缺少必要运行库/组件
  - 期望：明确提示缺失项与离线安装方式（若提供离线运行库随包分发则直接引导使用）。

## 9. 质量与默认策略（Defaults）

- 默认离线、默认不出网：启动与核心功能路径不得产生外网请求。
- 默认最小权限：仅用户态运行，不申请管理员权限。
- 默认最小暴露面：全局 loopback-only，不对外暴露端口。
- 默认便携：所有数据默认落在解压目录。

## 10. 约束与风险（Constraints）

- 约束：
  - Windows 环境
  - zip 免安装 + 绿色便携
  - 无登录、无授权
  - loopback 允许，但不要求防火墙入站规则
  - 固定入口端口 `route_port=13159`

- 风险：
  - 部分自动化能力可能天然依赖更高权限或系统组件（例如驱动级能力、系统级 hook）。若出现此类能力，需单独确认取舍。
  - 离线保留“全部功能”可能导致包体积显著增加（尤其是视觉/AI 等）。需要在后续迭代中定义“可选组件包”。
  - 现有代码中若存在默认更新检查/市场请求等启动链路，必须在离线模式下被抑制，否则会破坏“默认不出网”。

## 11. 验收口径（MVP）

- AC-1：在断网环境下，解压 zip 后直接启动桌面端，无登录/授权步骤。
- AC-2：桌面端可拉起本地引擎与必要服务，且所有监听仅在 127.0.0.1（全局）。
- AC-3：`route_port=13159` 可用；若端口占用，给出明确提示与解决方案。
- AC-4：可运行一个示例流程，产生本地日志与运行输出，均落在解压目录下。
- AC-5：与联网相关能力在离线模式下统一置灰并标注“离线不可用”，且不阻塞核心运行。
- AC-6：全程不需要管理员权限，不需要用户配置防火墙规则。

---
